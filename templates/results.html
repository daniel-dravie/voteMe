<<<<<<< SEARCH
{% extends "base.html" %}
{% block title %}Election Results{% endblock %}

{% block content %}

<h2>Election Results</h2>

<div class="results-filter">
  <form method="get" action="{{ url_for('view_results') }}">
    <label for="portfolio-select">Select portfolio:</label>
    <select name="portfolio_id" id="portfolio-select">
      <option value="">-- choose portfolio --</option>
      {% for p in portfolios %}
        <option value="{{ p.id }}" {% if selected_portfolio_id == p.id %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
    </select>
    <button type="submit">View</button>
  </form>
</div>

<div id="results-section" class="{% if not selected_portfolio %}results-hidden{% endif %}">
  {% if selected_portfolio %}
    <h3 class="results-portfolio-title">{{ selected_portfolio.name }}</h3>

    {% if selected_portfolio.candidates %}
      <p class="results-summary">
        Total votes in this portfolio:
        <strong>{{ portfolio_total_votes }}</strong>
        {% if skipped_percentage is not none %}
          &nbsp;|&nbsp; Skipped:
          <strong>{{ skipped_percentage }}%</strong>
        {% endif %}
      </p>

      <!-- Container where the winner group / spotlight card will be injected -->
      <div id="winner-group-container"></div>

      <div class="results-grid">
        {% for candidate in selected_portfolio.candidates %}
          <div class="result-card {% if candidate.id in winner_ids %}winner{% endif %}">
            <div class="result-photo-wrap">
              {% if candidate.photo %}
                <img
                  src="{{ url_for('static', filename='uploads/' ~ candidate.photo) }}"
                  alt="{{ candidate.user.name if candidate.user else 'Candidate photo' }}"
                  class="result-photo"
                  data-votes="{{ candidate.votes }}"
                >
              {% else %}
                <div class="result-photo placeholder">
                  No photo
                </div>
              {% endif %}
            </div>
            <div class="result-meta">
              <div class="candidate-name">
                {{ candidate.user.name if candidate.user else 'N/A' }}
              </div>
              <div class="candidate-class">
                {{ candidate.classroom.name if candidate.classroom else 'N/A' }}
              </div>
              <div class="candidate-votes">
                Votes: {{ candidate.votes }}
                {% if candidate.percentage is defined %}
                  ({{ '%.1f' % candidate.percentage }}%)
                {% endif %}
              </div>
              <div class="candidate-status">
                {% if candidate.id in winner_ids %}
                  <strong>Winner</strong>
                {% else %}
                  -
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if winner_ids %}
        <button id="show-winner-btn" type="button" class="show-winner-btn">
          Show winner
        </button>
      {% endif %}
    {% else %}
      <p>No candidates registered for this portfolio.</p>
    {% endif %}
  {% else %}
    <p>Please select a portfolio to view its results.</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const showWinnerBtn = document.getElementById("show-winner-btn");
    if (!showWinnerBtn) return;

    showWinnerBtn.addEventListener("click", function () {
      const allCards = document.querySelectorAll(".result-card");
      const winnerCards = document.querySelectorAll(".result-card.winner");
      const container = document.getElementById("winner-group-container");

      if (!winnerCards.length || !container) return;

      // Clear any previous group/spotlight card
      container.innerHTML = "";

      // Make all non-winners much smaller
      allCards.forEach(card => {
        if (!card.classList.contains("winner")) {
          card.classList.add("loser-active");
        } else {
          card.classList.remove("loser-active");
        }
      });

      if (winnerCards.length === 1) {
        // Single winner: spotlight card, hide original in grid
        const original = winnerCards[0];
        const clone = original.cloneNode(true);
        clone.classList.add("winner-spotlight-card");
        container.appendChild(clone);

        // Hide the original winner card in the grid
        original.style.display = "none";

        clone.scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
        // Multiple winners: group card with all winners side-by-side, hide originals
        const groupCard = document.createElement("div");
        groupCard.className = "winner-group-card";

        const inner = document.createElement("div");
        inner.className = "winner-group-inner";

        winnerCards.forEach(card => {
          const clone = card.cloneNode(true);
          inner.appendChild(clone);
          // hide original card in grid
          card.style.display = "none";
        });

        groupCard.appendChild(inner);
        container.appendChild(groupCard);
        groupCard.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    });
  });
</script>
{% endblock %}

